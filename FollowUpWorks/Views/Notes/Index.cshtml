@model IEnumerable<FollowUpWorks.DTOs.NoteClassDTO>
@{
    ViewData["Title"] = "Mis Notas";
}
<div class="mt-5 pt-4"></div>
<div class="container py-5">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1"><i class="bi bi-journal-text text-primary me-2"></i>Mis Notas</h1>
            <p class="text-muted mb-0">Gestiona y organiza tus notas</p>
        </div>
        <a asp-action="Create" class="btn btn-primary">
            <i class="bi bi-plus-lg me-1"></i>Nueva Nota
        </a>
    </div>

    <!-- Alertas -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle me-2"></i>@TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-circle me-2"></i>@TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Búsqueda -->
    <div class="card shadow-sm mb-4">
        <div class="card-body py-2">
            <div class="input-group">
                <span class="input-group-text bg-transparent border-0">
                    <i class="bi bi-search"></i>
                </span>
                <input type="text" id="searchNotes" class="form-control border-0"
                       placeholder="Buscar notas...">
            </div>
        </div>
    </div>

    <!-- Grid de notas -->
    <div class="row" id="notesGrid">
        @if (Model != null && Model.Any())
        {
            @foreach (var note in Model.OrderByDescending(n => n.CreationDate))
            {
                <div class="col-md-4 col-lg-3 mb-4 note-card"
                     data-search="@note.Title.ToLower() @note.Content.ToLower()">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header bg-primary text-white py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-truncate me-2" style="max-width: 150px;" title="@note.Title">
                                    <i class="bi bi-file-text me-1"></i>@note.Title
                                </span>
                                <div class="btn-group">
                                    <a asp-action="Details" asp-route-id="@note.idNotes"
                                       class="btn btn-sm btn-light" title="Ver">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    <a asp-action="Edit" asp-route-id="@note.idNotes"
                                       class="btn btn-sm btn-light" title="Editar">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <button type="button" class="btn btn-sm btn-light text-danger btn-delete-note"
                                            data-id="@note.idNotes"
                                            data-title="@note.Title"
                                            title="Eliminar">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <p class="card-text small" style="min-height: 80px;">
                                @(note.Content.Length > 120 ? note.Content.Substring(0, 120) + "..." : note.Content)
                            </p>
                        </div>
                        <div class="card-footer bg-light py-2">
                            <small class="text-muted">
                                <i class="bi bi-calendar3 me-1"></i>@note.CreationDate.ToString("dd/MM/yyyy HH:mm")
                            </small>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="col-12" id="emptyState">
                <div class="text-center py-5">
                    <i class="bi bi-journal text-muted" style="font-size: 4rem;"></i>
                    <h5 class="mt-3 text-muted">No hay notas</h5>
                    <p class="text-muted">Crea tu primera nota</p>
                    <a asp-action="Create" class="btn btn-primary">
                        <i class="bi bi-plus-lg me-1"></i>Nueva Nota
                    </a>
                </div>
            </div>
        }
    </div>

    <!-- No results -->
    <div id="noResults" class="text-center py-5 d-none">
        <i class="bi bi-search text-muted" style="font-size: 3rem;"></i>
        <h5 class="mt-3 text-muted">Sin resultados</h5>
    </div>
</div>

<!-- Modal Eliminar -->
<div class="modal fade" id="modalDelete" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>Eliminar Nota</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>¿Eliminar la nota "<strong id="deleteNoteTitle"></strong>"?</p>
                <p class="text-muted small mb-0">Esta acción no se puede deshacer.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <a id="deleteNoteLink" href="#" class="btn btn-danger">
                    <i class="bi bi-trash me-1"></i>Eliminar
                </a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function() {
            // Búsqueda
            var searchInput = document.getElementById('searchNotes');
            var notesGrid = document.getElementById('notesGrid');
            var noResults = document.getElementById('noResults');

            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    var term = this.value.toLowerCase();
                    var cards = document.querySelectorAll('.note-card');
                    var visible = 0;

                    cards.forEach(function(card) {
                        var text = card.getAttribute('data-search') || '';
                        if (text.includes(term)) {
                            card.style.display = '';
                            visible++;
                        } else {
                            card.style.display = 'none';
                        }
                    });

                    if (noResults) {
                        noResults.classList.toggle('d-none', visible > 0 || term === '');
                    }
                });
            }

            // Eliminar
            var deleteModal = document.getElementById('modalDelete');
            var deleteTitle = document.getElementById('deleteNoteTitle');
            var deleteLink = document.getElementById('deleteNoteLink');

            document.querySelectorAll('.btn-delete-note').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var id = this.getAttribute('data-id');
                    var title = this.getAttribute('data-title');

                    if (deleteTitle) deleteTitle.textContent = title;
                    if (deleteLink) deleteLink.href = '@Url.Action("Delete", "Notes")/' + id;

                    if (deleteModal && typeof bootstrap !== 'undefined') {
                        new bootstrap.Modal(deleteModal).show();
                    }
                });
            });
        })();
    </script>
}